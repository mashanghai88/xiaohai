const N_MASTER = "ğ˜”ğ˜¢ğ˜´ğ˜µğ˜¦ğ˜³", N_CORE = "ğ˜Šğ˜°ğ˜³ğ˜¦ ğ˜—ğ˜°ğ˜°ğ˜­", N_AI = "ğ˜ˆğ˜-ğ˜–ğ˜¯ğ˜­ğ˜º", N_TG = "ğ˜›ğ˜¦ğ˜­ğ˜¦ğ˜¨ğ˜³ğ˜¢ğ˜®", N_LOW = "ğ˜“ğ˜°ğ˜¸ğ˜™ğ˜¢ğ˜µğ˜¦", N_HK = "ğ˜ğ˜’ ğ˜•ğ˜°ğ˜¥ğ˜¦", N_TW = "ğ˜›ğ˜ ğ˜•ğ˜°ğ˜¥ğ˜¦", N_JP = "ğ˜‘ğ˜— ğ˜•ğ˜°ğ˜¥ğ˜¦", N_SG = "ğ˜šğ˜ ğ˜•ğ˜°ğ˜¥ğ˜¦", N_US = "ğ˜œğ˜š ğ˜•ğ˜°ğ˜¥ğ˜¦", N_EU = "ğ˜Œğ˜œ ğ˜•ğ˜°ğ˜¥ğ˜¦", N_OT = "ğ˜–ğ˜› ğ˜•ğ˜°ğ˜¥ğ˜¦";
const EX_INFO = "(?i)é‡ç½®|åˆ°æœŸ|é¢‘é“|å¥—é¤|å‰©ä½™|æœ‰æ•ˆ|ç¾|ç½‘æ˜“|Netease|è®¢é˜…|ç¾¤|è´¦æˆ·|æµé‡|æœ‰æ•ˆæœŸ|æ—¶é—´|å®˜ç½‘";
const EU_REG = "(?i)ğŸ‡¬ğŸ‡§|è‹±å›½|UK|ğŸ‡«ğŸ‡·|æ³•å›½|FR|ğŸ‡©ğŸ‡ª|å¾·å›½|DE|ğŸ‡³ğŸ‡±|è·å…°|NL|ğ˜ğ˜›|æ„å¤§åˆ©|Italy|ğ˜Œğ˜š|è¥¿ç­ç‰™|Spain|ğ˜Šğ˜|ç‘å£«|Switzerland|ğ˜šğ˜Œ|ç‘å…¸|Sweden|ğ˜—ğ˜“|æ³¢å…°|Poland|ğ˜ˆğ˜›|å¥¥åœ°åˆ©|Austria|ğ˜ğ˜Œ|çˆ±å°”å…°|Ireland|ğ˜‰ğ˜Œ|æ¯”åˆ©æ—¶|Belgium";
const ALL_REGION_REG = `(?i)é¦™æ¸¯|HK|Hong|å°æ¹¾|TW|Tai|Japan|æ—¥æœ¬|JP|Singapore|æ–°åŠ å¡|SG|States|ç¾å›½|US|America|${EU_REG}`;

const ruleProviderCommon = { "interval": 86400, "proxy": "ğ˜”ğ˜¢ğ˜´ğ˜µğ˜¦ğ˜³", "type": "http", "format": "mrs", "behavior": "classical" };
const groupBaseOption = { "interval": 300, "url": "http://www.gstatic.com/generate_204", "lazy": true, "tolerance": 80, "timeout": 5000, "max-failed-times": 3, "include-all": true };

const main = (config) => {
  if (!(config?.proxies?.length || config["proxy-providers"])) throw new Error("No Proxies Found");

  Object.assign(config, {
    "mixed-port": 7890,
    "allow-lan": true,
    "mode": "rule",
    "log-level": "info",
    "ipv6": false,
    "unified-delay": true,
    "tcp-concurrent": true,
    "find-process-mode": "strict",
    "global-client-fingerprint": "chrome",
    "geodata-mode": true,
    "geox-url": {
      "geoip": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip.metadb",
      "geosite": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat",
      "mmdb": "https://testingcf.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/country.mmdb",
      "asn": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/GeoLite2-ASN.mmdb"
    },
    "profile": { "store-selected": true, "store-fake-ip": true, "smart-collector-size": 100 }
  });

  config["sniffer"] = {
    "enable": true,
    "force-dns-mapping": true,
    "parse-pure-ip": true,
    "override-destination": true,
    "skip-domain": ["openai", "chatgpt", "anthropic", "claude", "gemini", "grok", "perplexity", "poe"],
    "sniff": { 
      "TLS": { "ports": [443, 8443] }, 
      "HTTP": { "ports": [80, "8080-8880"], "override-destination": true }, 
      "QUIC": { "ports": [443, 8443] } 
    }
  };

  config["tun"] = { "enable": true, "stack": "system", "auto-route": true, "auto-detect-interface": true, "dns-hijack": ["any:53"] };

  config["dns"] = {
    "enable": true,
    "listen": "0.0.0.0:1053",
    "use-hosts": true,
    "respect-rules": true,
    "ipv6": false,
    "cache-algorithm": "arc",
    "enhanced-mode": "fake-ip",
    "fake-ip-range": "198.18.0.1/16",
    "fake-ip-range6": "fdfe:dcba:9876::/64",
    "fake-ip-filter": ["RULE-SET:AIä¸“å±", "RULE-SET:Fakeip-Filter", "RULE-SET:Private"],
    "default-nameserver": ["223.5.5.5", "119.29.29.29"],
    "direct-nameserver": ["https://doh.pub/dns-query", "https://dns.alidns.com/dns-query"],
    "nameserver": ["https://dns.alidns.com/dns-query", "https://doh.pub/dns-query"],
    "proxy-server-nameserver": ["https://doh.pub/dns-query"],
    "nameserver-policy": {
      "geosite:cn,private": ["https://dns.alidns.com/dns-query", "https://doh.pub/dns-query"],
      "geosite:geolocation-!cn": ["https://cloudflare-dns.com/dns-query", "https://dns.google/dns-query"]
    },
    "hosts": { 
      "dns.alidns.com": ["223.5.5.5", "223.6.6.6"], 
      "doh.pub": ["1.12.12.21", "120.53.53.53"], 
      "cloudflare-dns.com": ["1.1.1.1", "1.0.0.1"], 
      "dns.google": ["8.8.8.8", "8.8.4.4"] 
    }
  };

  function createRegionGroups({ itName, isLowRate, icon, filter }) {
    const subAuto = `${itName}-ğ˜ˆğ˜œğ˜›ğ˜–`, subFall = `${itName}-ğ˜ğ˜ˆğ˜“ğ˜“`, groupName = isLowRate ? itName : `${itName} ğ˜•ğ˜°ğ˜¥ğ˜¦`;
    return [
      { ...groupBaseOption, name: groupName, type: "select", proxies: [subAuto, subFall], filter, icon, "exclude-filter": EX_INFO },
      { ...groupBaseOption, name: subAuto, type: "url-test", hidden: true, filter, "exclude-filter": EX_INFO },
      { ...groupBaseOption, name: subFall, type: "fallback", hidden: true, filter, "exclude-filter": EX_INFO }
    ];
  }

  const regions = [
    ...createRegionGroups({ itName: "ğ˜“ğ˜°ğ˜¸ğ˜™ğ˜¢ğ˜µğ˜¦", isLowRate: true, icon: "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Download.png", filter: "(?<![0-9])0\\.(?:0[0-9]{1,2}|[1-9])(?![0-9])" }),
    ...createRegionGroups({ itName: "ğ˜ğ˜’", icon: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/icon/color/hk.png", filter: "(?i)æ¸¯|HK|hk|Hong Kong|ğŸ‡­ğŸ‡°" }),
    ...createRegionGroups({ itName: "ğ˜›ğ˜", icon: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/icon/color/tw.png", filter: "(?i)å°|TW|tw|Taiwan|ğŸ‡¨ğŸ‡³|ğŸ‡¹ğŸ‡¼" }),
    ...createRegionGroups({ itName: "ğ˜‘ğ˜—", icon: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/icon/color/jp.png", filter: "(?i)æ—¥æœ¬|ä¸œäº¬|å¤§é˜ª|JP|jp|Japan|ğŸ‡¯ğŸ‡µ" }),
    ...createRegionGroups({ itName: "ğ˜šğ˜", icon: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/icon/color/sg.png", filter: "(?i)æ–°åŠ å¡|å¡|SG|ç‹®åŸ|Singapore|ğŸ‡¸ğŸ‡¬" }),
    ...createRegionGroups({ itName: "ğ˜œğ˜š", icon: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/icon/color/us.png", filter: "(?i)ç¾|US|us|United States|America|ğŸ‡ºğŸ‡¸" }),
    ...createRegionGroups({ itName: "ğ˜Œğ˜œ", icon: "https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/icon/01Country/EuropeanUnion(2).png", filter: EU_REG })
  ];

  config["proxy-groups"] = [
    { ...groupBaseOption, name: N_MASTER, type: "select", proxies: [N_HK, N_TW, N_JP, N_SG, N_US, N_EU, N_OT, N_LOW, N_CORE, "DIRECT"], icon: "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Final.png", "exclude-filter": EX_INFO },
    { ...groupBaseOption, name: N_CORE, type: "select", proxies: ["ğ˜Šğ˜–ğ˜™ğ˜Œ-ğ˜ˆğ˜œğ˜›ğ˜–", "ğ˜Šğ˜–ğ˜™ğ˜Œ-ğ˜ğ˜ˆğ˜“ğ˜“"], icon: "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Area.png", "exclude-filter": EX_INFO },
    { ...groupBaseOption, name: "ğ˜Šğ˜–ğ˜™ğ˜Œ-ğ˜ˆğ˜œğ˜›ğ˜–", type: "url-test", hidden: true, "exclude-filter": EX_INFO },
    { ...groupBaseOption, name: "ğ˜Šğ˜–ğ˜™ğ˜Œ-ğ˜ğ˜ˆğ˜“ğ˜“", type: "fallback", hidden: true, "exclude-filter": EX_INFO },
    { ...groupBaseOption, name: N_AI, type: "select", proxies: [N_TW, N_JP, N_SG, N_US, N_EU, N_OT, N_LOW, N_CORE], icon: "https://fastly.jsdelivr.net/gh/Orz-3/mini@master/Color/OpenAI.png", "exclude-filter": EX_INFO },
    { ...groupBaseOption, name: N_TG, type: "select", proxies: [N_MASTER, N_HK, N_TW, N_JP, N_SG, N_US, N_EU, N_OT, N_LOW, N_CORE], icon: "https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/icon/04ProxySoft/Telegrampremium.png", "exclude-filter": EX_INFO },
    ...regions,
    { ...groupBaseOption, name: N_OT, type: "select", proxies: ["ğ˜–ğ˜›-ğ˜ˆğ˜œğ˜›ğ˜–", "ğ˜–ğ˜›-ğ˜ğ˜ˆğ˜“ğ˜“"], "exclude-filter": `${ALL_REGION_REG}|${EX_INFO}`, icon: "https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Global.png" },
    { ...groupBaseOption, name: "ğ˜–ğ˜›-ğ˜ˆğ˜œğ˜›ğ˜–", type: "url-test", hidden: true, "exclude-filter": `${ALL_REGION_REG}|${EX_INFO}` },
    { ...groupBaseOption, name: "ğ˜–ğ˜›-ğ˜ğ˜ˆğ˜“ğ˜“", type: "fallback", hidden: true, "exclude-filter": `${ALL_REGION_REG}|${EX_INFO}` }
  ];

  const getP = (url, beh) => ({ ...ruleProviderCommon, behavior: beh, url, format: url.endsWith(".yaml") ? "yaml" : "mrs" });
  config["rule-providers"] = {
    "ç§‹é£å»å¹¿å‘Š": getP("https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Clash.mrs", "domain"),
    "STUN": getP("https://testingcf.jsdelivr.net/gh/Kwisma/rules@main/rules/mihomo/STUN/STUN_Domain.mrs", "domain"),
    "Fakeip-Filter": getP("https://testingcf.jsdelivr.net/gh/DustinWin/ruleset_geodata@mihomo-ruleset/fakeip-filter.mrs", "domain"),
    "Direct": getP("https://git.imee.me/https://github.com/666OS/rules/raw/release/mihomo/domain/Direct.mrs", "domain"),
    "Private": getP("https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/private.mrs", "domain"),
    "Private_IP": getP("https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/private.mrs", "ipcidr"),
    "AIä¸“å±": getP("https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/category-ai-!cn.mrs", "domain"),
    "telegram": getP("https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/telegram.mrs", "domain"),
    "telegram_ip": getP("https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/telegram.mrs", "ipcidr"),
    "Global": getP("https://cdn.jsdelivr.net/gh/GitMetaio/rule@master/rule/Clash/Global/Global_OCD_Domain.mrs", "domain"),
    "Global_IP": getP("https://cdn.jsdelivr.net/gh/GitMetaio/rule@master/rule/Clash/Global/Global_OCD_IP.mrs", "ipcidr"),
    "CN": getP("https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/cn.mrs", "domain"),
    "CN_IP": getP("https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/cn.mrs", "ipcidr")
  };

  config["rules"] = [
    "RULE-SET,ç§‹é£å»å¹¿å‘Š,REJECT",
    "RULE-SET,STUN,REJECT-DROP",
    "RULE-SET,Fakeip-Filter,DIRECT",
    "RULE-SET,Private,DIRECT",
    "RULE-SET,Private_IP,DIRECT,no-resolve",
    "RULE-SET,Direct,DIRECT",
    "RULE-SET,AIä¸“å±,ğ˜ˆğ˜-ğ˜–ğ˜¯ğ˜­ğ˜º",
    "RULE-SET,telegram,ğ˜›ğ˜¦ğ˜­ğ˜¦ğ˜¨ğ˜³ğ˜¢ğ˜®",
    "RULE-SET,telegram_ip,ğ˜›ğ˜¦ğ˜­ğ˜¦ğ˜¨ğ˜³ğ˜¢ğ˜®,no-resolve",
    "RULE-SET,Global,ğ˜”ğ˜¢ğ˜´ğ˜µğ˜¦ğ˜³",
    "RULE-SET,Global_IP,ğ˜”ğ˜¢ğ˜´ğ˜µğ˜¦ğ˜³,no-resolve",
    "RULE-SET,CN,DIRECT",
    "RULE-SET,CN_IP,DIRECT,no-resolve",
    "MATCH,ğ˜”ğ˜¢ğ˜´ğ˜µğ˜¦ğ˜³"
  ];

  return config;
};